# ============================================
# PSM-SafetyTwin 로컬 개발 환경
# docker-compose up -d 로 전체 서비스 시작
# ============================================

version: "3.9"

services:
  # ── SVC-01: P&ID 디지털화 엔진 ──
  pid-parser:
    build:
      context: ./services/pid-parser
      dockerfile: Dockerfile
    container_name: psm-pid-parser
    ports:
      - "8001:8001"
    environment:
      - POSTGRES_URL=postgresql+asyncpg://psm:psm@postgres:5432/pid_parser
      - NEO4J_URI=bolt://neo4j:7687
      - REDIS_URL=redis://redis:6379/0
      - DFINE_DEVICE=cpu  # 로컬 개발 시 CPU 모드
    volumes:
      - ./services/pid-parser/src:/app/src  # 핫 리로드
      - pid-uploads:/app/uploads
      - pid-outputs:/app/outputs
    depends_on:
      - postgres
      - neo4j
      - redis
    restart: unless-stopped

  # ── SVC-07: 플랫폼 공통 (인증/게이트웨이) ──
  # platform-core:
  #   build: ./services/platform-core
  #   ports:
  #     - "8000:8000"

  # ── 데이터베이스: PostgreSQL ──
  postgres:
    image: postgres:16-alpine
    container_name: psm-postgres
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: psm
      POSTGRES_PASSWORD: psm
      POSTGRES_DB: pid_parser
    volumes:
      - pgdata:/var/lib/postgresql/data
    restart: unless-stopped

  # ── 그래프 DB: Neo4j ──
  neo4j:
    image: neo4j:5-community
    container_name: psm-neo4j
    ports:
      - "7474:7474"  # 웹 콘솔
      - "7687:7687"  # Bolt 프로토콜
    environment:
      NEO4J_AUTH: neo4j/psm-safetytwin
    volumes:
      - neo4jdata:/data
    restart: unless-stopped

  # ── 메시지 브로커: Redis ──
  redis:
    image: redis:7-alpine
    container_name: psm-redis
    ports:
      - "6379:6379"
    restart: unless-stopped

volumes:
  pgdata:
  neo4jdata:
  pid-uploads:
  pid-outputs:
